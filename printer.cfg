[include mainsail.cfg]
[include microprobe.cfg]
# Ender 3 + SKR Mini E3 V3.0 + BTT MicroProbe + Direct Drive

[mcu]
serial: /dev/serial/by-id/usb-Klipper_stm32g0b1xx_1C00470001504E5238363120-if00

[printer]
kinematics: cartesian
max_velocity: 500
max_accel: 3000
max_z_velocity: 10
max_z_accel: 100

# ================================================================================
# Steppers
# ================================================================================
[stepper_x]
step_pin: PB13
dir_pin: !PB12
enable_pin: !PB14
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC0
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_y]
step_pin: PB10
dir_pin: !PB2
enable_pin: !PB11
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC1
position_endstop: 0
position_max: 235
homing_speed: 50

[stepper_z]
step_pin: PB0
dir_pin: PC5
enable_pin: !PB1
microsteps: 16
rotation_distance: 8
# endstop_pin: ^PC2
# position_endstop: 0.0
endstop_pin: probe:z_virtual_endstop
position_max: 250
position_min: -2

[extruder]
step_pin: PB3
dir_pin: !PB4
enable_pin: !PD1
microsteps: 16
rotation_distance: 7.498
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC8  # Korrekt pin för hotend heater på V3.0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PA0  # Korrekt ADC-pin för hotend termistor
control: pid
pid_kp: 30.171
pid_ki: 1.916
pid_kd: 118.799
min_temp: 0
max_temp: 260

# ================================================================================
# Heaters & Fans
# ================================================================================
[heater_bed]
heater_pin: PC9  # Korrekt pin för bed heater på V3.0
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC4  # Korrekt ADC-pin för bed termistor på V3.0
control: pid
pid_kp: 73.497
pid_ki: 1.672
pid_kd: 807.547
min_temp: 0
max_temp: 130

[fan]  # Part cooling fan
pin: PC6  # Korrekt pin för part cooling på V3.0

[heater_fan heatbreak_cooling_fan]  # Hotend fan
pin: PC7  # Korrekt pin för hotend fan på V3.0
heater: extruder
heater_temp: 25.0
fan_speed: 1.0

# ================================================================================
# TMC2209 (shared UART mode med address för V3.0 – löser pin-konflikt)
# ================================================================================
[tmc2209 stepper_x]
uart_pin: PC11
tx_pin: PC10
uart_address: 0
run_current: 0.580
hold_current: 0.500
stealthchop_threshold: 999999

[tmc2209 stepper_y]
uart_pin: PC11
tx_pin: PC10
uart_address: 2
run_current: 0.580
hold_current: 0.500
stealthchop_threshold: 999999

[tmc2209 stepper_z]
uart_pin: PC11
tx_pin: PC10
uart_address: 1
run_current: 0.580
hold_current: 0.500
stealthchop_threshold: 999999

[tmc2209 extruder]
uart_pin: PC11
tx_pin: PC10
uart_address: 3
run_current: 0.800
stealthchop_threshold: 999999

# ================================================================================
# Virtual SD
# ================================================================================
[virtual_sdcard]
path: ~/printer_data/gcodes
on_error_gcode: CANCEL_PRINT

# ================================================================================
# Input Shaper
# ================================================================================
[input_shaper]
shaper_type_x: zv
shaper_freq_x: 54.2
shaper_type_y: 2hump_ei
shaper_freq_y: 47.2
